#!/usr/bin/env python3
"""
{{ project_name }} - GUI Application
Generated by Copier Template
"""

import sys
import os
from pathlib import Path
from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QVBoxLayout, QHBoxLayout, QWidget,
    QPushButton, QLabel, QLineEdit, QFileDialog, QMessageBox,
    QProgressBar, QTextEdit, QCheckBox, QGroupBox, QGridLayout
)
from PyQt5.QtCore import QThread, pyqtSignal, Qt
from PyQt5.QtGui import QFont
import pandas as pd

# Import the main processing functions
from main import worker_function, save_outputs


class WorkerThread(QThread):
    """Worker thread for processing data without blocking UI."""

    finished = pyqtSignal(dict)
    error = pyqtSignal(str)
    progress = pyqtSignal(str)

    def __init__(self, {% for input in inputs_config %}{{ input.identifier }}_path{% if not loop.last %}, {% endif %}{% endfor %}):
        super().__init__()
        {% for input in inputs_config %}
        self.{{ input.identifier }}_path = {{ input.identifier }}_path
        {% endfor %}

    def run(self):
        """Run the worker function in a separate thread."""
        try:
            self.progress.emit("Starting data processing...")

            results = worker_function(
                {% for input in inputs_config %}
                self.{{ input.identifier }}_path{% if not loop.last %},
                {% endif %}
                {% endfor %}
            )

            self.progress.emit("Processing completed successfully!")
            self.finished.emit(results)

        except Exception as e:
            self.error.emit(str(e))


class {{ project_name.replace('_', '').title() }}GUI(QMainWindow):
    """Main GUI application for {{ project_name }}."""

    def __init__(self):
        super().__init__()
        self.results = None
        self.worker_thread = None
        self.initUI()

    def initUI(self):
        """Initialize the user interface."""
        self.setWindowTitle("{{ project_name.replace('_', ' ').title() }}")
        self.setGeometry(100, 100, 800, 600)

        # Create central widget and layout
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        layout = QVBoxLayout(central_widget)

        # Add title
        title_label = QLabel("{{ project_name.replace('_', ' ').title() }}")
        title_font = QFont()
        title_font.setPointSize(16)
        title_font.setBold(True)
        title_label.setFont(title_font)
        title_label.setAlignment(Qt.AlignCenter)
        layout.addWidget(title_label)

        # Input files section
        input_group = QGroupBox("Input Files")
        input_layout = QGridLayout(input_group)

        {% for input in inputs_config %}
        # {{ input.placeholder }}
        input_layout.addWidget(QLabel("{{ input.placeholder }}:"), {{ loop.index0 }}, 0)
        self.{{ input.identifier }}_path = QLineEdit()
        self.{{ input.identifier }}_path.setReadOnly(True)
        input_layout.addWidget(self.{{ input.identifier }}_path, {{ loop.index0 }}, 1)

        self.{{ input.identifier }}_button = QPushButton("Browse...")
        self.{{ input.identifier }}_button.clicked.connect(self.browse_{{ input.identifier }})
        input_layout.addWidget(self.{{ input.identifier }}_button, {{ loop.index0 }}, 2)

        {% endfor %}

        layout.addWidget(input_group)

        # UI Controls section
        {% if num_ui_inputs > 0 %}
        ui_group = QGroupBox("Controls")
        ui_layout = QGridLayout(ui_group)

        {% for ui_input in ui_inputs_config %}
        {% if ui_input.type == "File Selection" %}
        # {{ ui_input.label }} (File Selection)
        ui_layout.addWidget(QLabel("{{ ui_input.label }}:"), {{ loop.index0 }}, 0)
        self.{{ ui_input.variable }}_path = QLineEdit()
        self.{{ ui_input.variable }}_path.setReadOnly(True)
        ui_layout.addWidget(self.{{ ui_input.variable }}_path, {{ loop.index0 }}, 1)

        self.{{ ui_input.variable }}_button = QPushButton("Browse...")
        self.{{ ui_input.variable }}_button.clicked.connect(self.browse_{{ ui_input.variable }}_file)
        ui_layout.addWidget(self.{{ ui_input.variable }}_button, {{ loop.index0 }}, 2)

        {% elif ui_input.type == "Folder Selection" %}
        # {{ ui_input.label }} (Folder Selection)
        ui_layout.addWidget(QLabel("{{ ui_input.label }}:"), {{ loop.index0 }}, 0)
        self.{{ ui_input.variable }}_path = QLineEdit()
        self.{{ ui_input.variable }}_path.setReadOnly(True)
        ui_layout.addWidget(self.{{ ui_input.variable }}_path, {{ loop.index0 }}, 1)

        self.{{ ui_input.variable }}_button = QPushButton("Browse...")
        self.{{ ui_input.variable }}_button.clicked.connect(self.browse_{{ ui_input.variable }}_folder)
        ui_layout.addWidget(self.{{ ui_input.variable }}_button, {{ loop.index0 }}, 2)

        {% elif ui_input.type == "Checkbox" %}
        # {{ ui_input.label }} (Checkbox)
        self.{{ ui_input.variable }}_checkbox = QCheckBox("{{ ui_input.label }}")
        ui_layout.addWidget(self.{{ ui_input.variable }}_checkbox, {{ loop.index0 }}, 0, 1, 3)

        {% endif %}
        {% endfor %}

        layout.addWidget(ui_group)
        {% endif %}

        # Process button
        self.process_button = QPushButton("Process Data")
        self.process_button.clicked.connect(self.process_data)
        self.process_button.setMinimumHeight(40)
        layout.addWidget(self.process_button)

        # Progress bar
        self.progress_bar = QProgressBar()
        self.progress_bar.setVisible(False)
        layout.addWidget(self.progress_bar)

        # Status text
        self.status_text = QTextEdit()
        self.status_text.setMaximumHeight(150)
        self.status_text.setReadOnly(True)
        layout.addWidget(self.status_text)

        # Save results button
        self.save_button = QPushButton("Save Results")
        self.save_button.clicked.connect(self.save_results)
        self.save_button.setEnabled(False)
        layout.addWidget(self.save_button)

    {% for input in inputs_config %}
    def browse_{{ input.identifier }}(self):
        """Browse for {{ input.placeholder }} file."""
        {% if input.format == "CSV" %}
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "Select {{ input.placeholder }}",
            "",
            "CSV Files (*.csv);;All Files (*)"
        )
        {% else %}
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "Select {{ input.placeholder }}",
            "",
            "Excel Files (*.xlsx *.xls);;All Files (*)"
        )
        {% endif %}

        if file_path:
            self.{{ input.identifier }}_path.setText(file_path)

    {% endfor %}

    {% if num_ui_inputs > 0 %}
    {% for ui_input in ui_inputs_config %}
    {% if ui_input.type == "File Selection" %}
    def browse_{{ ui_input.variable }}_file(self):
        """Browse for {{ ui_input.label }} file."""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "Select {{ ui_input.label }}",
            "",
            "All Files (*)"
        )

        if file_path:
            self.{{ ui_input.variable }}_path.setText(file_path)

    {% elif ui_input.type == "Folder Selection" %}
    def browse_{{ ui_input.variable }}_folder(self):
        """Browse for {{ ui_input.label }} folder."""
        folder_path = QFileDialog.getExistingDirectory(
            self,
            "Select {{ ui_input.label }}"
        )

        if folder_path:
            self.{{ ui_input.variable }}_path.setText(folder_path)

    {% endif %}
    {% endfor %}
    {% endif %}

    def validate_inputs(self):
        """Validate that all required inputs are provided."""
        {% for input in inputs_config %}
        if not self.{{ input.identifier }}_path.text().strip():
            QMessageBox.warning(self, "Warning", "Please select {{ input.placeholder }}.")
            return False

        if not Path(self.{{ input.identifier }}_path.text()).exists():
            QMessageBox.warning(self, "Warning", "{{ input.placeholder }} file does not exist.")
            return False

        {% endfor %}

        return True

    def process_data(self):
        """Process the data using the worker thread."""
        if not self.validate_inputs():
            return

        # Disable the process button and show progress
        self.process_button.setEnabled(False)
        self.progress_bar.setVisible(True)
        self.progress_bar.setRange(0, 0)  # Indeterminate progress
        self.status_text.clear()
        self.status_text.append("Starting data processing...")

        # Create and start worker thread
        self.worker_thread = WorkerThread(
            {% for input in inputs_config %}
            self.{{ input.identifier }}_path.text(){% if not loop.last %},
            {% endif %}
            {% endfor %}
        )

        self.worker_thread.finished.connect(self.on_processing_finished)
        self.worker_thread.error.connect(self.on_processing_error)
        self.worker_thread.progress.connect(self.on_progress_update)
        self.worker_thread.start()

    def on_processing_finished(self, results):
        """Handle successful processing completion."""
        self.results = results
        self.progress_bar.setVisible(False)
        self.process_button.setEnabled(True)
        self.save_button.setEnabled(True)

        self.status_text.append("Processing completed successfully!")
        self.status_text.append(f"Generated {len(results)} result datasets.")

        QMessageBox.information(self, "Success", "Data processing completed successfully!")

    def on_processing_error(self, error_message):
        """Handle processing errors."""
        self.progress_bar.setVisible(False)
        self.process_button.setEnabled(True)

        self.status_text.append(f"Error: {error_message}")

        QMessageBox.critical(self, "Error", f"Processing failed:\n{error_message}")

    def on_progress_update(self, message):
        """Handle progress updates."""
        self.status_text.append(message)
        # Auto-scroll to bottom
        scrollbar = self.status_text.verticalScrollBar()
        scrollbar.setValue(scrollbar.maximum())

    def save_results(self):
        """Save the processing results."""
        if not self.results:
            QMessageBox.warning(self, "Warning", "No results to save. Please process data first.")
            return

        # Ask user for output directory
        output_dir = QFileDialog.getExistingDirectory(
            self,
            "Select Output Directory"
        )

        if not output_dir:
            return

        try:
            save_outputs(self.results, output_dir)
            self.status_text.append(f"Results saved to: {output_dir}")
            QMessageBox.information(self, "Success", f"Results saved successfully to:\n{output_dir}")
        except Exception as e:
            error_msg = f"Failed to save results: {str(e)}"
            self.status_text.append(error_msg)
            QMessageBox.critical(self, "Error", error_msg)


def main():
    """Main function to run the GUI application."""
    app = QApplication(sys.argv)

    # Set application properties
    app.setApplicationName("{{ project_name.replace('_', ' ').title() }}")
    app.setApplicationVersion("1.0.0")

    # Create and show main window
    window = {{ project_name.replace('_', '').title() }}GUI()
    window.show()

    sys.exit(app.exec_())


if __name__ == "__main__":
    main()
